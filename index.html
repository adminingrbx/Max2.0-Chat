<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ê–ö–° ¬∑ –û–±—â–∏–µ —á–∞—Ç—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0c1b2f 0%, #1a3b5c 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 900px;
            background: rgba(10, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0, 20, 50, 0.6);
            border-radius: 28px;
            border: 1px solid rgba(100, 180, 255, 0.2);
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (–∞–∫–∫–∞—É–Ω—Ç) */
        .login-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
            color: #fff;
        }

        .login-screen h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #6dd5ff, #3a8cff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .login-screen .sub {
            font-size: 1rem;
            color: #a0c4ff;
            margin-bottom: 30px;
            border-left: 4px solid #3a8cff;
            padding-left: 12px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6dd5ff;
            margin-bottom: 6px;
        }

        .input-group input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid #2a4f6e;
            color: #fff;
            font-size: 1rem;
            padding: 14px 16px;
            border-radius: 18px;
            outline: none;
            transition: all 0.2s;
        }

        .input-group input:focus {
            border-color: #3a8cff;
            box-shadow: 0 0 0 3px rgba(58, 140, 255, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #3a8cff, #6dd5ff);
            color: #0b1a2a;
            font-weight: 700;
            font-size: 1rem;
            padding: 16px;
            border: none;
            border-radius: 30px;
            width: 100%;
            cursor: pointer;
            margin-top: 8px;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 8px 16px rgba(0, 100, 255, 0.3);
        }

        .btn.secondary {
            background: transparent;
            border: 2px solid #3a8cff;
            color: #6dd5ff;
            box-shadow: none;
            margin-top: 12px;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .error-message {
            color: #ff8a8a;
            font-size: 0.9rem;
            margin-top: 16px;
            text-align: center;
            background: rgba(180, 0, 0, 0.2);
            padding: 10px;
            border-radius: 20px;
            display: none;
            border: 1px solid #ff4d4d;
        }

        /* –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (—Å –≤–∫–ª–∞–¥–∫–∞–º–∏) */
        .chats-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(10, 25, 40, 0.95);
            display: none;
        }

        .chats-header {
            background: rgba(20, 40, 60, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a4f6e;
        }

        .chats-header h2 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #6dd5ff, #3a8cff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .add-chat-btn {
            background: linear-gradient(135deg, #3a8cff, #6dd5ff);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 2rem;
            color: #0b1a2a;
            cursor: pointer;
            box-shadow: 0 4px 10px #1f5590;
        }

        .tabs {
            display: flex;
            background: #1a2a3a;
            border-bottom: 1px solid #2a4f6e;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            color: #8aa9cc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab.active {
            color: #6dd5ff;
            border-bottom: 2px solid #6dd5ff;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-item {
            background: rgba(30, 50, 70, 0.6);
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #2a4f6e;
            transition: background 0.2s;
            cursor: pointer;
        }

        .chat-item:hover {
            background: rgba(40, 60, 80, 0.8);
        }

        .chat-item-info h3 {
            color: #fff;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .chat-item-info p {
            color: #8aa9cc;
            font-size: 0.8rem;
        }

        .chat-item-arrow {
            color: #6dd5ff;
            font-size: 1.5rem;
        }

        .chat-type-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 20px;
            background: #2a4f6e;
            color: #a0c4ff;
            margin-left: 8px;
        }

        /* –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ */
        .new-chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
            background: rgba(10, 25, 40, 0.95);
            display: none;
        }

        .new-chat-screen h2 {
            color: #fff;
            margin-bottom: 20px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: #fff;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ */
        .password-dialog {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        .password-dialog-content {
            background: #1f2c33;
            padding: 24px;
            border-radius: 28px;
            width: 80%;
            max-width: 300px;
            border: 1px solid #2a4f6e;
        }
        .password-dialog-content h3 {
            color: #fff;
            margin-bottom: 16px;
        }
        .password-dialog-content input {
            width: 100%;
            background: #122c40;
            border: 1px solid #2a4f6e;
            color: #fff;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 16px;
        }

        /* –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è) */
        .chat-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            display: none;
        }

        .chat-header {
            background: rgba(20, 40, 60, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a4f6e;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: none;
            border: none;
            color: #6dd5ff;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0 5px;
        }

        .chat-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #fff;
        }

        .user-status {
            font-size: 0.7rem;
            color: #a0c4ff;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #6dd5ff;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .logout-btn {
            background: none;
            border: none;
            color: #a0c4ff;
            font-size: 1.6rem;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
        }
        .logout-btn:hover { color: #ff8a8a; }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(10, 25, 40, 0.6);
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-wrapper.incoming { align-self: flex-start; }
        .message-wrapper.outgoing { align-self: flex-end; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 22px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 20, 50, 0.4);
        }

        .incoming .message-bubble {
            background: linear-gradient(145deg, #1e3b5a, #152a40);
            color: #e6f0ff;
            border-bottom-left-radius: 6px;
            border: 1px solid #2a4f6e;
        }

        .outgoing .message-bubble {
            background: linear-gradient(145deg, #2b6bb0, #1f5590);
            color: white;
            border-bottom-right-radius: 6px;
            border: 1px solid #3a8cff;
        }

        .message-time {
            font-size: 0.65rem;
            color: #8aa9cc;
            margin: 4px 8px 0;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 4px;
            opacity: 0.7;
        }

        .message-actions button {
            background: none;
            border: none;
            color: #8aa9cc;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .message-actions button:hover {
            color: #6dd5ff;
            background: rgba(255,255,255,0.1);
        }

        .input-area {
            background: rgba(20, 40, 60, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            border-top: 1px solid #2a4f6e;
            flex-wrap: wrap;
        }

        .emoji-panel {
            display: flex;
            gap: 8px;
            padding: 8px 0;
            width: 100%;
            justify-content: space-around;
            background: rgba(0,0,0,0.2);
            border-radius: 30px;
            margin-bottom: 4px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 1.6rem;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .emoji-btn:active { transform: scale(1.3); }

        .input-wrapper {
            display: flex;
            flex: 1;
            gap: 8px;
            align-items: flex-end;
        }

        .input-area textarea {
            flex: 1;
            background: #122c40;
            border: 1px solid #2a4f6e;
            border-radius: 24px;
            color: white;
            font-size: 0.95rem;
            padding: 12px 18px;
            resize: none;
            max-height: 120px;
            outline: none;
            line-height: 1.4;
        }

        .action-btn {
            background: linear-gradient(135deg, #3a8cff, #6dd5ff);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #0b1a2a;
            font-size: 1.3rem;
            flex-shrink: 0;
            transition: all 0.2s;
            box-shadow: 0 4px 10px #1f5590;
        }

        .voice-btn {
            background: linear-gradient(135deg, #ff7b7b, #ff4d4d);
        }

        .cancel-btn {
            background: #4a5f73;
            box-shadow: none;
        }

        .sync-status {
            color: #6dd5ff;
            font-size: 0.8rem;
            padding: 4px 16px;
            font-style: italic;
            background: #122c40;
            text-align: center;
            border-top: 1px solid #2a4f6e;
        }

        .empty-chat {
            color: #8aa9cc;
            text-align: center;
            margin-top: 40px;
            font-style: italic;
        }

        .edited-mark {
            font-size: 0.6rem;
            color: #aac8ff;
            margin-left: 4px;
        }

        audio {
            max-width: 200px;
            height: 32px;
            border-radius: 16px;
        }
        .voice-message {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .voice-duration {
            font-size: 0.8rem;
            color: #aac8ff;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- –î–∏–∞–ª–æ–≥ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ -->
        <div class="password-dialog" id="passwordDialog">
            <div class="password-dialog-content">
                <h3>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —á–∞—Ç–∞</h3>
                <input type="password" id="chatPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn" id="submitPasswordBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="btn secondary" id="cancelPasswordBtn">–û—Ç–º–µ–Ω–∞</button>
                <div class="error-message" id="passwordError"></div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç -->
        <div class="login-screen" id="loginScreen">
            <h1>–ú–ê–ö–°</h1>
            <div class="sub">–æ–±—â–∏–µ —á–∞—Ç—ã ¬∑ E2E ¬∑ GitHub Gist</div>
            
            <div class="input-group">
                <label>–õ–û–ì–ò–ù</label>
                <input type="text" id="loginUsernameInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: alice" autocomplete="off">
            </div>

            <div class="input-group">
                <label>–ü–ê–†–û–õ–¨</label>
                <input type="password" id="loginPasswordInput" placeholder="******">
            </div>

            <button class="btn" id="loginBtn">–í–û–ô–¢–ò</button>
            <button class="btn secondary" id="registerBtn">–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø</button>

            <div class="error-message" id="loginError"></div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (—Å –≤–∫–ª–∞–¥–∫–∞–º–∏) -->
        <div class="chats-screen" id="chatsScreen">
            <div class="chats-header">
                <h2>–ß–∞—Ç—ã</h2>
                <button class="add-chat-btn" id="addChatBtn">+</button>
            </div>
            <div class="tabs">
                <div class="tab active" id="tabMyChats">–ú–æ–∏ —á–∞—Ç—ã</div>
                <div class="tab" id="tabPublicChats">–û–±—â–∏–µ —á–∞—Ç—ã</div>
            </div>
            <div class="chats-list" id="chatsList">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
        <div class="new-chat-screen" id="newChatScreen">
            <h2>–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</h2>
            <div class="input-group">
                <label>–ù–ê–ó–í–ê–ù–ò–ï –ß–ê–¢–ê</label>
                <input type="text" id="newChatNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–±–æ—Ç–∞">
            </div>
            <div class="radio-group">
                <label><input type="radio" name="chatType" value="public" checked> –û–±—â–∏–π</label>
                <label><input type="radio" name="chatType" value="private"> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π (—Å –ø–∞—Ä–æ–ª–µ–º)</label>
            </div>
            <div class="input-group" id="passwordField" style="display: none;">
                <label>–ü–ê–†–û–õ–¨ –ß–ê–¢–ê</label>
                <input type="password" id="newChatPasswordInput" placeholder="–ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" id="createChatBtn">–°–û–ó–î–ê–¢–¨</button>
            <button class="btn secondary" id="cancelNewChatBtn">–û–¢–ú–ï–ù–ê</button>
            <div class="error-message" id="newChatError"></div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è) -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="back-btn" id="backToChatsBtn">‚Üê</button>
                    <div>
                        <div class="chat-title" id="currentChatTitle">...</div>
                        <div class="user-status"><span class="status-dot"></span> Gist —Å–∏–Ω—Ö—Ä.</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">‚èª</button>
            </div>

            <div class="messages-container" id="messageList">
                <div class="empty-chat">üëã –ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
            </div>

            <div class="sync-status" id="syncStatus"></div>

            <div class="input-area" id="inputArea">
                <div class="emoji-panel" id="emojiPanel">
                    <button class="emoji-btn">üòä</button>
                    <button class="emoji-btn">üòÇ</button>
                    <button class="emoji-btn">‚ù§Ô∏è</button>
                    <button class="emoji-btn">üëç</button>
                    <button class="emoji-btn">üî•</button>
                    <button class="emoji-btn">üéâ</button>
                </div>
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" rows="1"></textarea>
                    <button class="action-btn" id="sendBtn">‚û§</button>
                    <button class="action-btn voice-btn" id="voiceBtn">üé§</button>
                    <button class="action-btn cancel-btn" id="cancelEditBtn" style="display: none;">‚úï</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // === –î–ê–ù–ù–´–ï GITHUB ============================
        // ==============================================
        const ACCOUNTS_GIST_ID = '3cf194078a56ab87ed209e5030ec29df';      // Gist –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        const ACCOUNTS_FILENAME = 'Accounts';                             // —Ñ–∞–π–ª –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        const PUBLIC_CHATS_GIST_ID = '998215e1f3fc7cf47afae8a98d9386a6';       // –ó–î–ï–°–¨ –ù–£–ñ–ù–û –í–°–¢–ê–í–ò–¢–¨ ID –ù–û–í–û–ì–û GIST
        const PUBLIC_CHATS_FILENAME = 'public_chats.json';                // —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –æ–±—â–∏—Ö —á–∞—Ç–æ–≤
        const GITHUB_TOKEN = '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';  // —Ç–≤–æ–π —Ç–æ–∫–µ–Ω

        // ==============================================
        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        // ==============================================
        let currentUser = { username: '', chats: [] }; // –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentChat = null; // { id, name, key, fileName } –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç
        let messages = [];
        let pollingInterval = null;
        let isSending = false;
        let editingMessageId = null;

        // –î–ª—è –≤–∫–ª–∞–¥–æ–∫
        let activeTab = 'my'; // 'my' –∏–ª–∏ 'public'
        let publicChatsList = []; // –∫—ç—à —Å–ø–∏—Å–∫–∞ –æ–±—â–∏—Ö —á–∞—Ç–æ–≤

        // –î–ª—è –¥–∏–∞–ª–æ–≥–∞ –ø–∞—Ä–æ–ª—è
        let pendingPublicChat = null; // —á–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const loginScreen = document.getElementById('loginScreen');
        const chatsScreen = document.getElementById('chatsScreen');
        const newChatScreen = document.getElementById('newChatScreen');
        const chatScreen = document.getElementById('chatScreen');
        const loginUsernameInput = document.getElementById('loginUsernameInput');
        const loginPasswordInput = document.getElementById('loginPasswordInput');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginError = document.getElementById('loginError');
        const chatsList = document.getElementById('chatsList');
        const addChatBtn = document.getElementById('addChatBtn');
        const newChatNameInput = document.getElementById('newChatNameInput');
        const createChatBtn = document.getElementById('createChatBtn');
        const cancelNewChatBtn = document.getElementById('cancelNewChatBtn');
        const newChatError = document.getElementById('newChatError');
        const backToChatsBtn = document.getElementById('backToChatsBtn');
        const currentChatTitle = document.getElementById('currentChatTitle');
        const logoutBtn = document.getElementById('logoutBtn');
        const messageList = document.getElementById('messageList');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const syncStatus = document.getElementById('syncStatus');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const tabMyChats = document.getElementById('tabMyChats');
        const tabPublicChats = document.getElementById('tabPublicChats');
        const passwordDialog = document.getElementById('passwordDialog');
        const chatPasswordInput = document.getElementById('chatPasswordInput');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const chatTypeRadios = document.querySelectorAll('input[name="chatType"]');
        const passwordField = document.getElementById('passwordField');
        const newChatPasswordInput = document.getElementById('newChatPasswordInput');

        // ========== –§–£–ù–ö–¶–ò–ò –°–ï–°–°–ò–ò (localStorage) ==========
        function saveSession() {
            const session = {
                username: currentUser.username,
                chats: currentUser.chats
            };
            localStorage.setItem('max_session', JSON.stringify(session));
        }

        function loadSession() {
            const saved = localStorage.getItem('max_session');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    currentUser.username = session.username;
                    currentUser.chats = session.chats || [];
                    return true;
                } catch (e) {
                    console.error('Failed to load session', e);
                }
            }
            return false;
        }

        function clearSession() {
            localStorage.removeItem('max_session');
        }

        // ========== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° GIST ==========
        async function getGistContent(gistId, fileName) {
            if (!GITHUB_TOKEN) {
                updateSyncStatus('‚ö†Ô∏è –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞');
                return null;
            }
            try {
                const url = `https://api.github.com/gists/${gistId}?_=${Date.now()}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) {
                    console.error('HTTP —Å—Ç–∞—Ç—É—Å:', response.status);
                    return null;
                }
                const data = await response.json();
                return data.files[fileName]?.content || '';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                return null;
            }
        }

        async function updateGistContent(gistId, fileName, content) {
            if (!GITHUB_TOKEN) return false;
            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { [fileName]: { content } }
                    })
                });
                return response.ok;
            } catch (error) {
                console.error('Update error:', error);
                return false;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Gist (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞)
        async function createChatGist(initialContent = '[]') {
            if (!GITHUB_TOKEN) return null;
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'Chat created by MAX messenger',
                        public: false,
                        files: {
                            'messages.json': { content: initialContent }
                        }
                    })
                });
                if (!response.ok) {
                    console.error('Create gist error:', await response.text());
                    return null;
                }
                const data = await response.json();
                return { id: data.id, fileName: 'messages.json' };
            } catch (error) {
                console.error('Create gist error:', error);
                return null;
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ö–ö–ê–£–ù–¢–û–í ==========
        async function loadAccounts() {
            const content = await getGistContent(ACCOUNTS_GIST_ID, ACCOUNTS_FILENAME);
            if (content === null) return null;
            if (!content.trim()) return {};
            try {
                return JSON.parse(content);
            } catch {
                return {};
            }
        }

        async function saveAccounts(accounts) {
            const content = JSON.stringify(accounts, null, 2);
            return await updateGistContent(ACCOUNTS_GIST_ID, ACCOUNTS_FILENAME, content);
        }

        async function checkCredentials(username, password) {
            const accounts = await loadAccounts();
            if (!accounts) return false;
            return accounts[username]?.password === password;
        }

        async function registerUser(username, password) {
            const accounts = await loadAccounts();
            if (!accounts) return false;
            if (accounts[username]) return false;
            accounts[username] = {
                password: password,
                chats: []
            };
            return await saveAccounts(accounts);
        }

        async function loadUserProfile(username) {
            const accounts = await loadAccounts();
            if (!accounts || !accounts[username]) return null;
            return accounts[username];
        }

        async function saveUserProfile(username, profile) {
            const accounts = await loadAccounts();
            if (!accounts) return false;
            accounts[username] = profile;
            return await saveAccounts(accounts);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–£–ë–õ–ò–ß–ù–´–• –ß–ê–¢–û–í ==========
        async function loadPublicChats() {
            const content = await getGistContent(PUBLIC_CHATS_GIST_ID, PUBLIC_CHATS_FILENAME);
            if (content === null) return null;
            if (!content.trim()) return [];
            try {
                return JSON.parse(content);
            } catch {
                return [];
            }
        }

        async function savePublicChats(chats) {
            const content = JSON.stringify(chats, null, 2);
            return await updateGistContent(PUBLIC_CHATS_GIST_ID, PUBLIC_CHATS_FILENAME, content);
        }

        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–ô ==========
        function encrypt(text, password) {
            return CryptoJS.AES.encrypt(text, password).toString();
        }
        function decrypt(cipherText, password) {
            try {
                const bytes = CryptoJS.AES.decrypt(cipherText, password);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch { return null; }
        }

        async function loadMessagesFromChat(chatId, chatKey, fileName = 'messages.json') {
            const encrypted = await getGistContent(chatId, fileName);
            if (encrypted === null) return null;
            if (!encrypted.trim()) return [];
            const decrypted = decrypt(encrypted, chatKey);
            if (!decrypted) return 'DECRYPT_FAILED';
            try {
                return JSON.parse(decrypted);
            } catch { return []; }
        }

        async function saveMessagesToChat(chatId, chatKey, messages, fileName = 'messages.json') {
            const encrypted = encrypt(JSON.stringify(messages), chatKey);
            return await updateGistContent(chatId, fileName, encrypted);
        }

        // ========== –û–¢–ü–†–ê–í–ö–ê/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï/–£–î–ê–õ–ï–ù–ò–ï ==========
        async function sendOrUpdateMessage(text) {
            if (!text.trim() || isSending || !currentChat) return;
            isSending = true;
            updateSyncStatus('üîÑ –æ–±—Ä–∞–±–æ—Ç–∫–∞...');

            const currentMessages = messages.slice();

            if (editingMessageId) {
                const index = currentMessages.findIndex(m => m.id === editingMessageId);
                if (index !== -1 && currentMessages[index].sender === currentUser.username && currentMessages[index].type !== 'voice') {
                    currentMessages[index].text = text;
                    currentMessages[index].edited = true;
                }
                editingMessageId = null;
                cancelEditBtn.style.display = 'none';
                sendBtn.innerHTML = '‚û§';
            } else {
                const newMsg = {
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                    text: text,
                    time: Date.now(),
                    sender: currentUser.username,
                    edited: false,
                    type: 'text'
                };
                currentMessages.push(newMsg);
            }

            if (await saveMessagesToChat(currentChat.id, currentChat.key, currentMessages, currentChat.fileName)) {
                messages = currentMessages;
                renderMessages();
                updateSyncStatus('‚úÖ –≥–æ—Ç–æ–≤–æ');
                setTimeout(() => updateSyncStatus(''), 1500);
            } else {
                updateSyncStatus('‚ùå –æ—à–∏–±–∫–∞');
            }
            isSending = false;
        }

        async function sendVoiceMessage(base64Data, durationSec) {
            if (!base64Data || isSending || !currentChat) return;
            isSending = true;
            updateSyncStatus('üîÑ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞...');

            const currentMessages = messages.slice();
            const newMsg = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                time: Date.now(),
                sender: currentUser.username,
                type: 'voice',
                data: base64Data,
                duration: durationSec
            };
            currentMessages.push(newMsg);

            if (await saveMessagesToChat(currentChat.id, currentChat.key, currentMessages, currentChat.fileName)) {
                messages = currentMessages;
                renderMessages();
                updateSyncStatus('‚úÖ –≥–æ–ª–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                setTimeout(() => updateSyncStatus(''), 1500);
            } else {
                updateSyncStatus('‚ùå –æ—à–∏–±–∫–∞');
            }
            isSending = false;
        }

        async function deleteMessage(messageId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            if (isSending || !currentChat) return;
            isSending = true;
            updateSyncStatus('üîÑ —É–¥–∞–ª–µ–Ω–∏–µ...');

            const currentMessages = messages.filter(m => m.id !== messageId);

            if (await saveMessagesToChat(currentChat.id, currentChat.key, currentMessages, currentChat.fileName)) {
                messages = currentMessages;
                renderMessages();
                updateSyncStatus('‚úÖ —É–¥–∞–ª–µ–Ω–æ');
                setTimeout(() => updateSyncStatus(''), 1500);
            } else {
                updateSyncStatus('‚ùå –æ—à–∏–±–∫–∞');
            }
            isSending = false;
        }

        // ========== –ó–ê–ü–ò–°–¨ –ì–û–õ–û–°–ê ==========
        async function startRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let options = { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 64000 };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { audioBitsPerSecond: 64000 };
                }
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                recordingStartTime = Date.now();

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const duration = Math.round((Date.now() - recordingStartTime) / 1000);
                    if (duration < 1) {
                        updateSyncStatus('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ');
                        return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = function() {
                        const base64 = reader.result.split(',')[1];
                        sendVoiceMessage(base64, duration);
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                voiceBtn.style.background = 'linear-gradient(135deg, #ff4d4d, #ff1a1a)';
                voiceBtn.textContent = '‚èπÔ∏è';
                updateSyncStatus('üé§ –ó–∞–ø–∏—Å—å (64 kbps) ...');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
                updateSyncStatus('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                voiceBtn.style.background = 'linear-gradient(135deg, #ff7b7b, #ff4d4d)';
                voiceBtn.textContent = 'üé§';
            }
        }

        voiceBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // ========== –†–ï–ù–î–ï–† –°–û–û–ë–©–ï–ù–ò–ô ==========
        function renderMessages() {
            if (!messages || messages.length === 0) {
                messageList.innerHTML = '<div class="empty-chat">üëã –ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>';
                return;
            }

            let html = '';
            messages.forEach(msg => {
                const time = new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isOutgoing = msg.sender === currentUser.username;
                const editedMark = msg.edited ? '<span class="edited-mark">—Ä–µ–¥.</span>' : '';

                let contentHtml = '';
                if (msg.type === 'voice') {
                    const audioSrc = `data:audio/webm;base64,${msg.data}`;
                    contentHtml = `
                        <div class="voice-message">
                            <audio controls src="${audioSrc}" style="width: 200px;"></audio>
                            <span class="voice-duration">${msg.duration} —Å–µ–∫</span>
                        </div>
                    `;
                } else {
                    contentHtml = `${escapeHtml(msg.text || '')} ${editedMark}`;
                }

                let actions = '';
                if (isOutgoing) {
                    actions = `
                        <div class="message-actions">
                            ${msg.type !== 'voice' ? `<button class="edit-msg" data-id="${msg.id}">‚úèÔ∏è</button>` : ''}
                            <button class="delete-msg" data-id="${msg.id}">üóëÔ∏è</button>
                        </div>
                    `;
                }

                html += `
                    <div class="message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}">
                        ${!isOutgoing ? `<div style="font-size:0.7rem; color:#6dd5ff; margin-bottom:2px;">${msg.sender}</div>` : ''}
                        <div class="message-bubble">
                            ${contentHtml}
                        </div>
                        <div class="message-time">${time}</div>
                        ${actions}
                    </div>
                `;
            });
            messageList.innerHTML = html;

            document.querySelectorAll('.edit-msg').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    startEditing(id);
                });
            });
            document.querySelectorAll('.delete-msg').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    deleteMessage(id);
                });
            });

            scrollToBottom();
        }

        function startEditing(id) {
            const msg = messages.find(m => m.id === id);
            if (!msg || msg.sender !== currentUser.username || msg.type === 'voice') return;
            editingMessageId = id;
            messageInput.value = msg.text;
            messageInput.focus();
            sendBtn.innerHTML = 'üíæ';
            cancelEditBtn.style.display = 'flex';
        }

        function cancelEditing() {
            editingMessageId = null;
            messageInput.value = '';
            sendBtn.innerHTML = '‚û§';
            cancelEditBtn.style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            messageList.scrollTop = messageList.scrollHeight;
        }

        function updateSyncStatus(text) {
            syncStatus.textContent = text;
        }

        // ========== –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê –ß–ê–¢–û–í (–í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –í–ö–õ–ê–î–ö–ò) ==========
        async function renderChatsList() {
            if (activeTab === 'my') {
                // –ú–æ–∏ —á–∞—Ç—ã
                if (!currentUser.chats || currentUser.chats.length === 0) {
                    chatsList.innerHTML = '<div class="empty-chat">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∏–∑ –æ–±—â–∏—Ö!</div>';
                    return;
                }

                let html = '';
                currentUser.chats.forEach(chat => {
                    html += `
                        <div class="chat-item" data-chat-id="${chat.id}" data-type="my">
                            <div class="chat-item-info">
                                <h3>${escapeHtml(chat.name)}</h3>
                                <p>ID: ${chat.id.slice(0, 8)}...</p>
                            </div>
                            <div class="chat-item-arrow">‚Üí</div>
                        </div>
                    `;
                });
                chatsList.innerHTML = html;

                document.querySelectorAll('.chat-item[data-type="my"]').forEach(item => {
                    item.addEventListener('click', () => {
                        const chatId = item.dataset.chatId;
                        const chat = currentUser.chats.find(c => c.id === chatId);
                        if (chat) {
                            openChat(chat);
                        }
                    });
                });
            } else {
                // –û–±—â–∏–µ —á–∞—Ç—ã
                const publicChats = await loadPublicChats();
                if (!publicChats) {
                    chatsList.innerHTML = '<div class="empty-chat">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–∏—Ö —á–∞—Ç–æ–≤</div>';
                    return;
                }
                if (publicChats.length === 0) {
                    chatsList.innerHTML = '<div class="empty-chat">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—â–∏—Ö —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>';
                    return;
                }

                let html = '';
                publicChats.forEach(chat => {
                    const typeLabel = chat.type === 'private' ? 'üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π' : 'üåç –û–±—â–∏–π';
                    html += `
                        <div class="chat-item" data-chat-id="${chat.id}" data-type="public" data-public-chat='${JSON.stringify(chat).replace(/'/g, "&#39;")}'>
                            <div class="chat-item-info">
                                <h3>${escapeHtml(chat.name)} <span class="chat-type-badge">${typeLabel}</span></h3>
                                <p>ID: ${chat.id.slice(0, 8)}...</p>
                            </div>
                            <div class="chat-item-arrow">‚ûï</div>
                        </div>
                    `;
                });
                chatsList.innerHTML = html;

                document.querySelectorAll('.chat-item[data-type="public"]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const publicChatStr = item.dataset.publicChat;
                        try {
                            const publicChat = JSON.parse(publicChatStr.replace(/&#39;/g, "'"));
                            handleJoinPublicChat(publicChat);
                        } catch (err) {
                            console.error('Failed to parse public chat', err);
                        }
                    });
                });
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–Ø –ö –û–ë–©–ï–ú–£ –ß–ê–¢–£ ==========
        function handleJoinPublicChat(publicChat) {
            if (publicChat.type === 'public') {
                // –ü—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è
                addChatToMyList(publicChat.id, publicChat.name, publicChat.key);
            } else {
                // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
                pendingPublicChat = publicChat;
                passwordDialog.style.display = 'flex';
                chatPasswordInput.value = '';
                passwordError.style.display = 'none';
            }
        }

        async function addChatToMyList(chatId, chatName, chatKey) {
            // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —á–∞—Ç–∞
            if (currentUser.chats.some(c => c.id === chatId)) {
                alert('–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–º —Å–ø–∏—Å–∫–µ');
                return;
            }
            // –î–æ–±–∞–≤–ª—è–µ–º
            const newChat = {
                id: chatId,
                name: chatName,
                key: chatKey,
                fileName: 'messages.json'
            };
            currentUser.chats.push(newChat);
            const profile = await loadUserProfile(currentUser.username);
            profile.chats = currentUser.chats;
            await saveUserProfile(currentUser.username, profile);
            saveSession();
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ú–æ–∏ —á–∞—Ç—ã" –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
            activeTab = 'my';
            tabMyChats.classList.add('active');
            tabPublicChats.classList.remove('active');
            renderChatsList();
        }

        // ========== –û–¢–ö–†–´–¢–¨ –ß–ê–¢ ==========
        async function openChat(chat) {
            console.log('Opening chat:', chat);
            currentChat = chat;
            currentChatTitle.textContent = chat.name;
            updateSyncStatus('üîÑ –∑–∞–≥—Ä—É–∑–∫–∞...');
            const result = await loadMessagesFromChat(chat.id, chat.key, chat.fileName || 'messages.json');
            if (result === null) {
                updateSyncStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (Gist –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)');
                console.error('Failed to load messages: Gist content is null');
                return;
            }
            if (result === 'DECRYPT_FAILED') {
                updateSyncStatus('üîê –û—à–∏–±–∫–∞ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
                console.error('Decryption failed for chat', chat);
                return;
            }
            messages = result || [];
            chatsScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            renderMessages();

            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                if (!currentChat) return;
                const newMsgs = await loadMessagesFromChat(currentChat.id, currentChat.key, currentChat.fileName);
                if (newMsgs && JSON.stringify(newMsgs) !== JSON.stringify(messages)) {
                    messages = newMsgs;
                    renderMessages();
                }
            }, 3000);
        }

        // ========== –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ß–ê–¢–ê (—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫) ==========
        async function createNewChat() {
            const chatName = newChatNameInput.value.trim();
            if (!chatName) {
                newChatError.style.display = 'block';
                newChatError.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞';
                return;
            }
            const type = document.querySelector('input[name="chatType"]:checked').value;
            let chatPassword = null;
            if (type === 'private') {
                chatPassword = newChatPasswordInput.value.trim();
                if (!chatPassword) {
                    newChatError.style.display = 'block';
                    newChatError.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞';
                    return;
                }
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
            let chatKey;
            if (type === 'public') {
                chatKey = CryptoJS.lib.WordArray.random(16).toString(); // —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á
            } else {
                // –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á = –ø–∞—Ä–æ–ª—å (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö–µ—à, –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Å–∞–º –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
                chatKey = chatPassword; 
            }

            // –°–æ–∑–¥–∞—ë–º Gist –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
            const gist = await createChatGist('[]');
            if (!gist) {
                newChatError.style.display = 'block';
                newChatError.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Gist';
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Gist –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
            const initialEncrypted = encrypt('[]', chatKey);
            const updated = await updateGistContent(gist.id, gist.fileName, initialEncrypted);
            if (!updated) {
                newChatError.style.display = 'block';
                newChatError.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç';
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ø—É–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
            const publicChats = await loadPublicChats() || [];
            const publicChatEntry = {
                id: gist.id,
                name: chatName,
                type: type,
                key: type === 'public' ? chatKey : undefined, // –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –æ—Ç–∫—Ä—ã—Ç–æ
                passwordHash: type === 'private' ? CryptoJS.SHA256(chatPassword).toString() : undefined
            };
            publicChats.push(publicChatEntry);
            const savedPublic = await savePublicChats(publicChats);
            if (!savedPublic) {
                newChatError.style.display = 'block';
                newChatError.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫';
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const newChat = {
                id: gist.id,
                name: chatName,
                key: chatKey,
                fileName: gist.fileName
            };
            currentUser.chats.push(newChat);
            const profile = await loadUserProfile(currentUser.username);
            profile.chats = currentUser.chats;
            const saved = await saveUserProfile(currentUser.username, profile);
            if (!saved) {
                newChatError.style.display = 'block';
                newChatError.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                return;
            }
            saveSession();

            newChatScreen.style.display = 'none';
            chatsScreen.style.display = 'flex';
            activeTab = 'my';
            tabMyChats.classList.add('active');
            tabPublicChats.classList.remove('active');
            renderChatsList();
            newChatNameInput.value = '';
            newChatPasswordInput.value = '';
            newChatError.style.display = 'none';
        }

        // ========== –í–•–û–î ==========
        async function handleLogin() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!username || !password) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            const ok = await checkCredentials(username, password);
            if (ok === null) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤';
                return;
            }
            if (!ok) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            const profile = await loadUserProfile(username);
            if (!profile) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è';
                return;
            }

            currentUser = {
                username: username,
                chats: profile.chats || []
            };
            saveSession();

            loginScreen.style.display = 'none';
            chatsScreen.style.display = 'flex';
            activeTab = 'my';
            tabMyChats.classList.add('active');
            tabPublicChats.classList.remove('active');
            renderChatsList();
            loginError.style.display = 'none';
        }

        async function handleRegister() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!username || !password) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';
                return;
            }

            const registered = await registerUser(username, password);
            if (registered === null) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤';
                return;
            }
            if (!registered) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ùå –õ–æ–≥–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                return;
            }

            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
            loginError.style.display = 'none';
        }

        // ========== –í–´–•–û–î ==========
        function logout() {
            clearInterval(pollingInterval);
            pollingInterval = null;
            messages = [];
            currentChat = null;
            currentUser = { username: '', chats: [] };
            clearSession();

            chatScreen.style.display = 'none';
            chatsScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
            loginUsernameInput.value = '';
            loginPasswordInput.value = '';
            updateSyncStatus('');
            cancelEditing();
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
        function showNewChatScreen() {
            chatsScreen.style.display = 'none';
            newChatScreen.style.display = 'flex';
        }

        function cancelNewChat() {
            newChatScreen.style.display = 'none';
            chatsScreen.style.display = 'flex';
            newChatError.style.display = 'none';
        }

        function backToChats() {
            chatScreen.style.display = 'none';
            chatsScreen.style.display = 'flex';
            clearInterval(pollingInterval);
            pollingInterval = null;
            currentChat = null;
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –í–ö–õ–ê–î–û–ö ==========
        tabMyChats.addEventListener('click', () => {
            activeTab = 'my';
            tabMyChats.classList.add('active');
            tabPublicChats.classList.remove('active');
            renderChatsList();
        });

        tabPublicChats.addEventListener('click', () => {
            activeTab = 'public';
            tabMyChats.classList.remove('active');
            tabPublicChats.classList.add('active');
            renderChatsList();
        });

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–ò–ê–õ–û–ì–ê –ü–ê–†–û–õ–Ø ==========
        submitPasswordBtn.addEventListener('click', async () => {
            const password = chatPasswordInput.value.trim();
            if (!password) {
                passwordError.style.display = 'block';
                passwordError.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                return;
            }
            if (!pendingPublicChat) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à –ø–∞—Ä–æ–ª—è
            const hash = CryptoJS.SHA256(password).toString();
            if (hash !== pendingPublicChat.passwordHash) {
                passwordError.style.display = 'block';
                passwordError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                return;
            }

            // –ü–∞—Ä–æ–ª—å –≤–µ—Ä–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç (–∫–ª—é—á = –ø–∞—Ä–æ–ª—å)
            await addChatToMyList(pendingPublicChat.id, pendingPublicChat.name, password);
            passwordDialog.style.display = 'none';
            pendingPublicChat = null;
        });

        cancelPasswordBtn.addEventListener('click', () => {
            passwordDialog.style.display = 'none';
            pendingPublicChat = null;
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞
        chatTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (document.querySelector('input[name="chatType"]:checked').value === 'private') {
                    passwordField.style.display = 'block';
                } else {
                    passwordField.style.display = 'none';
                }
            });
        });

        // ========== –°–û–ë–´–¢–ò–Ø ==========
        loginBtn.addEventListener('click', handleLogin);
        registerBtn.addEventListener('click', handleRegister);
        addChatBtn.addEventListener('click', showNewChatScreen);
        cancelNewChatBtn.addEventListener('click', cancelNewChat);
        createChatBtn.addEventListener('click', createNewChat);
        backToChatsBtn.addEventListener('click', backToChats);
        logoutBtn.addEventListener('click', logout);

        sendBtn.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendOrUpdateMessage(text);
                messageInput.value = '';
                messageInput.style.height = 'auto';
                cancelEditing();
            }
        });

        cancelEditBtn.addEventListener('click', cancelEditing);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (text) {
                    sendOrUpdateMessage(text);
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    cancelEditing();
                }
            }
        });

        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        emojiPanel.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji-btn')) {
                messageInput.value += e.target.textContent;
                messageInput.focus();
            }
        });

        window.addEventListener('load', async () => {
            if (!GITHUB_TOKEN) {
                loginError.style.display = 'block';
                loginError.textContent = '‚ö†Ô∏è –í—Å—Ç–∞–≤—å GITHUB_TOKEN –≤ –∫–æ–¥!';
            } else if (!PUBLIC_CHATS_GIST_ID || PUBLIC_CHATS_GIST_ID === '–í–ê–®_GIST_ID_–î–õ–Ø_–û–ë–©–ò–•_–ß–ê–¢–û–í') {
                loginError.style.display = 'block';
                loginError.textContent = '‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ PUBLIC_CHATS_GIST_ID!';
            } else {
                if (loadSession()) {
                    loginScreen.style.display = 'none';
                    chatsScreen.style.display = 'flex';
                    activeTab = 'my';
                    tabMyChats.classList.add('active');
                    tabPublicChats.classList.remove('active');
                    renderChatsList();
                }
            }
        });
    </script>
</body>
</html>